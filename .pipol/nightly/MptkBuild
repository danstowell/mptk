#!/bin/bash
 
#PIPOL ubuntu 1:00 
#PIPOL debian 1:00 
#PIPOL windows 1:00 --root
#PIPOL mac 1:00

case $PIPOL_IMAGE in
	*-mac-* | *-linux-*)
	
		# 1) You have to get your sources from somewhere.
		cd $PIPOL_WDIR
		echo "Voilà le chemin PIPOL_WDIR : $PIPOL_WDIR"
		svn checkout --username rleboulc https://scm.gforge.inria.fr/svn/mptk/trunk MPTK_Source
		
		# 2) Creation of the Build directory 
		if [ -d "MPTK_Build" ] then
		  echo "Le dossier MPTK_Build existe déjà..."
		else
		  echo "Le fichier MPTK_Build n'existe pas."
		  echo "Creation..."
		  mkdir MPTK_Build 
		  echo "Fin de la création..."
		fi
		
		# 3) the build 
		cd MPTK_Build; { 
		    ## 3.1) configuration
		    cmake -DDASH_TESTING=ON ../MPTK_Source
		    make NightlyUpdate
		    make NightlyConfigure
		
		    ## 3.2) build
		    make NightlyBuild
		
		    ## 3.3) test
		    make NightlyTest
		
		    ## 3.4) submission on a dashboard
		    make NightlySubmit
		
		    ## 3.4) packaging
		    cpack
		}; cd -
	;;
	*-windows-*)

		#Cleaning the project
		rm -Rf ./*

		if [ "$PIPOL_IMAGE" == "amd64-windows-server-2003-64bits.dd.gz" ]; then
        	PIPOL_WIN_COMPILER="Visual Studio 8 2005"
       		PIPOL_COMPILER_VERSION=8
		else 
        	PIPOL_WIN_COMPILER="Visual Studio 9 2008"
        	PIPOL_COMPILER_VERSION=9.0
		fi

		mkdir MPTK_Build 
		cd MPTK_Build
		#Making VISUAL project with cmake 2.6: don't forget to complete the line with your own sources path
		/cygdrive/c/CMake\ 2.8/bin/cmake.exe -G "$PIPOL_WIN_COMPILER" C:/MPTK_Source

		#Setting environment
		/cygdrive/c/Program\ Files\ \(x86\)/Microsoft\ Visual\ Studio\ $PIPOL_COMPILER_VERSION/Common7/Tools/vsvars32.bat	

		/cygdrive/c/Program\ Files\ \(x86\)/Microsoft\ Visual\ Studio\ $PIPOL_COMPILER_VERSION/VC/vcpackages/vcbuild.exe /CLEAN 

		#Project build
		/cygdrive/c/Program\ Files\ \(x86\)/Microsoft\ Visual\ Studio\ $PIPOL_COMPILER_VERSION/VC/vcpackages/vcbuild.exe MPTK.sln 

		#CDASH submision
		/cygdrive/c/CMake\ 2.8/bin/ctest.exe -D "Nightly" 

		#To make a Windows Package Installer
		/cygdrive/c/CMake\ 2.8/bin/cpack.exe -G "NSIS" 

		#and then you can save the package
	
	;;
	*)
	;;
esac


