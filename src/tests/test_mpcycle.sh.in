#!/bin/sh -x
#
#############################################################################
##                                                                         ##
##                               Makefile.am                               ##
##                                                                         ##
##                      Matching Pursuit Testing Suite                     ##
##                                                                         ##
## Rémi Gribonval                                                          ##
## Sacha Krstulovic                                        Mon Feb 21 2005 ##
## ----------------------------------------------------------------------- ##
##                                                                         ##
##  Copyright (C) 2005 IRISA                                               ##
##                                                                         ##
##  This program is free software; you can redistribute it and/or modify   ##
##  it under the terms of the GNU General Public License as published by   ##
##  the Free Software Foundation; either version 2, or (at your option)    ##
##  any later version.                                                     ##
##                                                                         ##
##  This program is distributed in the hope that it will be useful,        ##
##  but WITHOUT ANY WARRANTY; without even the implied warranty of         ##
##  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the          ##
##  GNU General Public License for more details.                           ##
##                                                                         ##
##  You should have received a copy of the GNU General Public License      ##
##  along with this program; if not, write to the Free Software            ##
##  Foundation, Inc., 59 Temple Place - Suite 330,                         ##
##  Boston, MA 02111-1307, USA.                                            ##
##                                                                         ##
#############################################################################
##
## SVN log:
##
##   $Author: sacha $
##   $Date$
##   $Revision$
##

refdir=@abs_top_srcdir@/src/tests
utilpath=@abs_top_builddir@/src/utils

mkdir -p current

echo "=================="

#
# check mpd
#
echo "===== Checking mpd:"

if test ! -x $utilpath/mpd; then
  echo "  You should probably build mpd before running the tests..."
  exit 1
fi

cmd="$utilpath/mpd  --verbose -s 10 -R 10 -D $refdir/signals/dico_test.xml $refdir/signals/mix_58_stereo.wav current/book_mix_58_stereo.bin current/res_mix_58_stereo.wav >& current/log_mpd_mix_58_stereo.log;"
echo $cmd
eval $cmd

diff -I 'mix_58_stereo' -I 'contains' @abs_top_builddir@/src/tests/current/log_mpd_mix_58_stereo.log $refdir/ref/log_mpd_mix_58_stereo.ref > /dev/null 2> /dev/null
if test $? -eq 0; then
  echo "  mpd -- test -- The current log is similar to the reference log. Test passed successfully."
else
  echo "  mpd -- test ERROR -- The current log differs from the reference log."
  echo "                       For details, execute:"
  echo "                         diff -I 'mix_58_stereo' -I 'contains' @abs_top_builddir@/src/tests/current/log_mpd_mix_58_stereo.log $refdir/ref/log_mpd_mix_58_stereo.ref"
  exit 1
fi

# diff current/book_mix_58_stereo.bin $refdir/ref/book_mix_58_stereo.bin.ref > /dev/null 2> /dev/null
# if test $? -eq 0 -a x`awk '{print NR}' current/${prog}.stderr | tail -1` = x; then
#   echo "  mpd -- test -- The current book is similar to the reference book."
# else
#   echo "  mpd -- test ERROR -- The current book differs from the reference book. (See current/log_mpd_mix_58_stereo.log for details.)"
#   exit 1
# fi
# 
# diff current/res_mix_58_stereo.wav $refdir/ref/res_mix_58_stereo.wav.ref > /dev/null 2> /dev/null
# if test $? -eq 0 -a x`awk '{print NR}' current/${prog}.stderr | tail -1` = x; then
#   echo "  mpd -- test -- The current residual is similar to the reference residual."
# else
#   echo "  mpd -- test ERROR -- The current residual differs from the reference residual. (See current/log_mpd_mix_58_stereo.log for details.)"
#   exit 1
# fi

#
# check mpr
#
echo "===== Checking mpr:"

if test ! -x $utilpath/mpr; then
  echo "  You should probably build mpr before running the tests..."
  exit 1
fi

echo "1) Rebuilding from the obtained book and residual:"

cmd="$utilpath/mpr --verbose current/book_mix_58_stereo.bin current/reconst_obt_mix_58_stereo.wav current/res_mix_58_stereo.wav >& current/log_mpr_obt_mix_58_stereo.log;"
echo $cmd
eval $cmd

diff -I 'mix_58_stereo' @abs_top_builddir@/src/tests/current/log_mpr_obt_mix_58_stereo.log $refdir/ref/log_mpr_mix_58_stereo.ref > /dev/null 2> /dev/null
if test $? -eq 0; then
  echo "  mpr -- test -- The current log is similar to the reference log. Test passed successfully."
else
  echo "  mpr -- test ERROR -- The current log differs from the reference log."
  echo "                       For details, execute:"
  echo "                         diff -I 'mix_58_stereo' @abs_top_builddir@/src/tests/current/log_mpr_obt_mix_58_stereo.log $refdir/ref/log_mpr_mix_58_stereo.ref"
  exit 1
fi

echo "2) Rebuilding from the reference book and residual:"

cmd="$utilpath/mpr --verbose $refdir/ref/book_mix_58_stereo.bin.ref current/reconst_ref_mix_58_stereo.wav $refdir/ref/res_mix_58_stereo.wav.ref >& current/log_mpr_ref_mix_58_stereo.log;"
echo $cmd
eval $cmd

diff -I 'mix_58_stereo' @abs_top_builddir@/src/tests/current/log_mpr_ref_mix_58_stereo.log $refdir/ref/log_mpr_mix_58_stereo.ref > /dev/null 2> /dev/null
if test $? -eq 0; then
  echo "  mpr -- test -- The current log is similar to the reference log. Test passed successfully."
else
  echo "  mpr -- test ERROR -- The current log differs from the reference log."
  echo "                       For details, execute:"
  echo "                         diff -I 'mix_58_stereo' @abs_top_builddir@/src/tests/current/log_mpr_ref_mix_58_stereo.log $refdir/ref/log_mpr_mix_58_stereo.ref"
  exit 1
fi


#
# check mpf
#
echo "===== Checking mpf:"

if test ! -x $utilpath/mpf; then
  echo "  You should probably build mpf before running the tests..."
  exit 1
fi

cmd="$utilpath/mpf --Freq=[0:110] --len=[0:256] current/book_mix_58_stereo.bin >& current/log_mpf_book_mix_58_stereo.bin.log;"
echo $cmd
eval $cmd

diff @abs_top_builddir@/src/tests/current/log_mpf_book_mix_58_stereo.bin.log $refdir/ref/log_mpf_book_mix_58_stereo.bin.ref > /dev/null 2> /dev/null
if test $? -eq 0; then
  echo "  mpf -- test -- The current log is similar to the reference log. Test passed successfully."
else
  echo "  mpf -- test ERROR -- The current log differs from the reference log."
  echo "                       For details, execute:"
  echo "                         diff @abs_top_builddir@/src/tests/current/log_mpf_book_mix_58_stereo.bin.log $refdir/ref/log_mpf_book_mix_58_stereo.bin.ref"
  exit 1
fi
